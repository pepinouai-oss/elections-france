<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âlections L√©gislatives 2024 - France</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <!-- En-t√™te -->
        <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üó≥Ô∏è √âlections L√©gislatives 2024</h1>
            <p class="text-gray-600">R√©sultats du 2√®me tour - 31 391 communes</p>
            <div class="mt-4">
                <a href="https://docs.google.com/spreadsheets/d/1655aOVKAbjEoT9qEzbEe1N_NKuNXBYux1z9Yol4PA8w/edit?usp=sharing" target="_blank" class="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-all inline-flex items-center gap-2">
                    üìä Ouvrir dans Google Sheets (nouvel onglet)
                </a>
            </div>
        </div>

        <!-- Panneau de filtres -->
        <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">üîç Recherche</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <!-- Recherche par Commune -->
                <div>
                    <label class="block text-sm font-semibold mb-2">üèòÔ∏è Rechercher une commune :</label>
                    <input 
                        type="text" 
                        id="communeSearch" 
                        placeholder="Ex: Moulins, Paris, Marseille..."
                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"
                        oninput="searchCommune()"
                    />
                    <select id="communeList" size="6" class="w-full mt-2 border-2 border-gray-300 rounded-lg p-2 hidden" onchange="selectCommune()">
                    </select>
                </div>

                <!-- Recherche par D√©partement -->
                <div>
                    <label class="block text-sm font-semibold mb-2">üìç S√©lectionner un d√©partement :</label>
                    <select id="deptSelect" class="w-full p-3 border-2 border-gray-300 rounded-lg" onchange="selectDepartement(); searchCommune();">
                        <option value="">-- Choisissez un d√©partement --</option>
                        <option value="FRANCE">üá´üá∑ FRANCE ENTI√àRE</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Filtrer les communes par d√©partement</p>
                </div>
            </div>

            <button onclick="resetView()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-400 transition-all">
                üîÑ R√©initialiser
            </button>
        </div>

        <!-- Zone de r√©sultats -->
        <div id="loadingZone" class="hidden bg-white rounded-2xl shadow-2xl p-8 text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
            <p class="mt-4 text-gray-600">Chargement...</p>
        </div>

        <!-- VUE D√âPARTEMENT -->
        <div id="departementView" class="hidden">
            <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4" id="deptTitle"></h2>
                
                <!-- Statistiques globales -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-indigo-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600">Communes</p>
                        <p class="text-2xl font-bold text-indigo-900" id="deptCommunes">-</p>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600">Total voix</p>
                        <p class="text-2xl font-bold text-indigo-900" id="deptVoix">-</p>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600">Inscrits</p>
                        <p class="text-2xl font-bold text-indigo-900" id="deptInscrits">-</p>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600">Si√®ges</p>
                        <p class="text-2xl font-bold text-indigo-900" id="deptSieges">-</p>
                    </div>
                </div>

                <!-- Graphique d√©partemental -->
                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-4">üìä R√©partition par parti</h3>
                    <canvas id="deptChart" height="80"></canvas>
                </div>

                <!-- Tableau r√©capitulatif -->
                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-4">üìã R√©sum√© par parti</h3>
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="text-left p-3">Parti</th>
                                <th class="text-right p-3">Voix totales</th>
                                <th class="text-right p-3">%</th>
                                <th class="text-right p-3">Si√®ges</th>
                            </tr>
                        </thead>
                        <tbody id="deptTableBody"></tbody>
                    </table>
                </div>

                <!-- Top 20 communes -->
                <div>
                    <h3 class="text-xl font-bold mb-4">üèÜ Top 20 des communes (par %)</h3>
                    <p class="text-sm text-gray-600 mb-4">Cliquez sur une commune pour voir le d√©tail</p>
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="text-left p-3">#</th>
                                <th class="text-left p-3">Commune</th>
                                <th class="text-left p-3">Candidat</th>
                                <th class="text-left p-3">Parti</th>
                                <th class="text-right p-3">Voix</th>
                                <th class="text-right p-3">%</th>
                            </tr>
                        </thead>
                        <tbody id="deptTopBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VUE COMMUNE -->
        <div id="communeView" class="hidden">
            <div class="bg-white rounded-2xl shadow-2xl p-6">
                <button onclick="backToDept()" class="mb-4 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 text-sm">
                    ‚Üê Retour au d√©partement
                </button>
                
                <div class="bg-indigo-50 p-6 rounded-lg mb-6">
                    <h2 class="text-3xl font-bold text-indigo-900" id="communeTitle"></h2>
                    <p class="text-indigo-700" id="communeInfo"></p>
                </div>

                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-4">üìä R√©sultats</h3>
                    <canvas id="communeChart" height="100"></canvas>
                </div>

                <div>
                    <h3 class="text-xl font-bold mb-4">üìã D√©tail des candidats</h3>
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="text-left p-3">Candidat</th>
                                <th class="text-left p-3">Parti</th>
                                <th class="text-right p-3">Voix</th>
                                <th class="text-right p-3">% Inscrits</th>
                                <th class="text-right p-3">% Exprim√©s</th>
                                <th class="text-center p-3">Statut</th>
                            </tr>
                        </thead>
                        <tbody id="communeTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://iflgdihwmmsaqtzhiyuz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmbGdkaWh3bW1zYXF0emhpeXV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MzUyMDQsImV4cCI6MjA3ODQxMTIwNH0.Y5zCvLQ4l3uJFWjZ_AH0L3HN8mrdPflOg1sZT5MPgmM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const partyColors = {
            'RN': '#0d378a', 'ENS': '#ffeb3b', 'LR': '#0066cc',
            'UG': '#ff4444', 'PS': '#ff8fab', 'PCF': '#dd0000',
            'DVG': '#ffaacc', 'DVD': '#6699cc'
        };

        let allCommunes = [];
        let currentDeptCode = null;
        let deptChart = null;
        let communeChart = null;

        function getColorByParti(parti) {
            return partyColors[parti] || '#888888';
        }

        async function init() {
            await loadDepartements();
            await loadAllCommunes();
        }

        async function loadDepartements() {
            try {
                const { data, error } = await supabase.from('departements_liste').select('*');
                if (error) throw error;

                const select = document.getElementById('deptSelect');
                while (select.options.length > 2) select.remove(2);

                data.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.departement_code;
                    option.textContent = `${dept.departement_code} - ${dept.departement_nom}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        async function loadAllCommunes() {
            try {
                const { data, error } = await supabase.from('communes_liste').select('*');
                if (error) throw error;

                allCommunes = data.map(c => ({
                    code: c.commune_code,
                    nom: c.commune_nom,
                    dept: c.departement_code
                }));
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        function searchCommune() {
            const input = document.getElementById('communeSearch').value.trim().toLowerCase();
            const list = document.getElementById('communeList');
            const selectedDept = document.getElementById('deptSelect').value;

            if (input.length < 2) {
                list.classList.add('hidden');
                return;
            }

            // Filtrer les communes
            let filtered = allCommunes.filter(c => {
                const nom = c.nom.toLowerCase();
                const matchesInput = nom.startsWith(input) || nom.split(/[\s-]/).some(word => word.startsWith(input));
                
                // Si un d√©partement est s√©lectionn√© (et que ce n'est pas FRANCE), filtrer par d√©partement
                if (selectedDept && selectedDept !== 'FRANCE' && selectedDept !== '') {
                    return matchesInput && c.dept === selectedDept;
                }
                
                return matchesInput;
            }).slice(0, 50);

            if (filtered.length === 0) {
                list.innerHTML = '<option disabled>Aucune commune trouv√©e</option>';
                list.classList.remove('hidden');
                return;
            }

            list.innerHTML = '';
            filtered.forEach(c => {
                const option = document.createElement('option');
                option.value = c.code;
                option.textContent = `${c.nom} (${c.dept})`;
                list.appendChild(option);
            });

            list.classList.remove('hidden');
        }

        async function selectCommune() {
            const code = document.getElementById('communeList').value;
            if (!code) return;

            document.getElementById('loadingZone').classList.remove('hidden');
            hideAllViews();

            try {
                const { data, error } = await supabase
                    .from('resultats_legislatives_2024')
                    .select('*')
                    .eq('commune_code', code)
                    .order('voix', { ascending: false });

                if (error) throw error;

                currentDeptCode = data[0].departement_code;
                displayCommune(data);
                document.getElementById('loadingZone').classList.add('hidden');
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('loadingZone').classList.add('hidden');
            }
        }

        async function selectDepartement() {
            const code = document.getElementById('deptSelect').value;
            if (!code) return;

            currentDeptCode = code;
            document.getElementById('loadingZone').classList.remove('hidden');
            hideAllViews();

            try {
                let query = supabase.from('resultats_legislatives_2024').select('*');
                if (code !== 'FRANCE') query = query.eq('departement_code', code);

                const { data, error } = await query;
                if (error) throw error;

                displayDepartement(data, code);
                document.getElementById('loadingZone').classList.add('hidden');
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('loadingZone').classList.add('hidden');
            }
        }

        function displayDepartement(data, deptCode) {
            const title = deptCode === 'FRANCE' ? 'üá´üá∑ France Enti√®re' : `üìç ${data[0].departement_code} - ${data[0].departement_nom}`;
            document.getElementById('deptTitle').textContent = title;

            const communes = new Set(data.map(d => d.commune_code));
            const totalVoix = data.reduce((sum, d) => sum + d.voix, 0);
            const sieges = data.filter(d => d.elu).length;

            document.getElementById('deptCommunes').textContent = communes.size;
            document.getElementById('deptVoix').textContent = totalVoix.toLocaleString();
            document.getElementById('deptInscrits').textContent = '-';
            document.getElementById('deptSieges').textContent = sieges;

            const partiStats = {};
            data.forEach(d => {
                if (!partiStats[d.parti]) partiStats[d.parti] = { voix: 0, sieges: 0 };
                partiStats[d.parti].voix += d.voix;
                if (d.elu) partiStats[d.parti].sieges++;
            });

            const sorted = Object.entries(partiStats).sort((a, b) => b[1].voix - a[1].voix);

            const ctx = document.getElementById('deptChart').getContext('2d');
            if (deptChart) deptChart.destroy();
            deptChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: sorted.map(p => p[0]),
                    datasets: [{ data: sorted.map(p => p[1].voix), backgroundColor: sorted.map(p => getColorByParti(p[0])) }]
                },
                options: { responsive: true, plugins: { legend: { position: 'right' } } }
            });

            const tbody = document.getElementById('deptTableBody');
            tbody.innerHTML = '';
            sorted.forEach(([parti, stats]) => {
                const pct = ((stats.voix / totalVoix) * 100).toFixed(2);
                tbody.innerHTML += `<tr class="border-b hover:bg-gray-50">
                    <td class="p-3"><span class="px-3 py-1 rounded-full text-white text-sm font-semibold" style="background-color: ${getColorByParti(parti)}">${parti}</span></td>
                    <td class="p-3 text-right font-bold">${stats.voix.toLocaleString()}</td>
                    <td class="p-3 text-right">${pct}%</td>
                    <td class="p-3 text-right font-bold">${stats.sieges}</td>
                </tr>`;
            });

            const top20 = [...data].sort((a, b) => b.pourcentage_exprimes - a.pourcentage_exprimes).slice(0, 20);
            const topBody = document.getElementById('deptTopBody');
            topBody.innerHTML = '';
            top20.forEach((d, i) => {
                topBody.innerHTML += `<tr class="border-b hover:bg-indigo-50 cursor-pointer" onclick="loadCommuneByCode('${d.commune_code}')">
                    <td class="p-3">#${i + 1}</td>
                    <td class="p-3 font-semibold text-indigo-600">${d.commune_nom}</td>
                    <td class="p-3">${d.candidat_nom}</td>
                    <td class="p-3"><span class="px-2 py-1 rounded text-white text-sm" style="background-color: ${getColorByParti(d.parti)}">${d.parti}</span></td>
                    <td class="p-3 text-right font-bold">${d.voix.toLocaleString()}</td>
                    <td class="p-3 text-right font-bold">${d.pourcentage_exprimes.toFixed(2)}%</td>
                </tr>`;
            });

            document.getElementById('departementView').classList.remove('hidden');
        }

        async function loadCommuneByCode(code) {
            document.getElementById('loadingZone').classList.remove('hidden');
            hideAllViews();

            try {
                const { data, error } = await supabase.from('resultats_legislatives_2024').select('*').eq('commune_code', code).order('voix', { ascending: false });
                if (error) throw error;

                displayCommune(data);
                document.getElementById('loadingZone').classList.add('hidden');
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('loadingZone').classList.add('hidden');
            }
        }

        function displayCommune(data) {
            const commune = data[0];
            document.getElementById('communeTitle').textContent = commune.commune_nom;
            document.getElementById('communeInfo').textContent = `${commune.departement_nom} (${commune.departement_code})`;

            const ctx = document.getElementById('communeChart').getContext('2d');
            if (communeChart) communeChart.destroy();
            communeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.candidat_nom),
                    datasets: [{ label: 'Voix', data: data.map(d => d.voix), backgroundColor: data.map(d => getColorByParti(d.parti)), borderRadius: 8 }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });

            const tbody = document.getElementById('communeTableBody');
            tbody.innerHTML = '';
            data.forEach(d => {
                tbody.innerHTML += `<tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-medium">${d.candidat_nom} ${d.candidat_prenom}</td>
                    <td class="p-3"><span class="px-3 py-1 rounded-full text-white text-sm font-semibold" style="background-color: ${getColorByParti(d.parti)}">${d.parti}</span></td>
                    <td class="p-3 text-right font-bold">${d.voix.toLocaleString()}</td>
                    <td class="p-3 text-right">${d.pourcentage_inscrits.toFixed(2)}%</td>
                    <td class="p-3 text-right font-bold">${d.pourcentage_exprimes.toFixed(2)}%</td>
                    <td class="p-3 text-center">${d.elu ? '<span class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold">√âLU</span>' : ''}</td>
                </tr>`;
            });

            document.getElementById('communeView').classList.remove('hidden');
        }

        function backToDept() {
            if (currentDeptCode) {
                document.getElementById('deptSelect').value = currentDeptCode;
                selectDepartement();
            }
        }

        function resetView() {
            document.getElementById('communeSearch').value = '';
            document.getElementById('deptSelect').value = '';
            document.getElementById('communeList').classList.add('hidden');
            hideAllViews();
        }

        function hideAllViews() {
            document.getElementById('departementView').classList.add('hidden');
            document.getElementById('communeView').classList.add('hidden');
        }

        document.getElementById('communeSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const list = document.getElementById('communeList');
                if (list.options.length > 0) {
                    list.selectedIndex = 0;
                    selectCommune();
                }
            }
        });

        init();
    </script>
</body>
</html>
