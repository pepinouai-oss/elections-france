<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âlections L√©gislatives 2024 - France</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <!-- En-t√™te -->
        <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üó≥Ô∏è √âlections L√©gislatives 2024</h1>
            <p class="text-gray-600">Tableau de bord unifi√© - 2√®me tour</p>
        </div>

        <!-- Panneau de filtres -->
        <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">üîç Filtres</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <!-- Filtre Commune -->
                <div>
                    <label class="block text-sm font-semibold mb-2">Commune :</label>
                    <input 
                        type="text" 
                        id="filterCommune" 
                        placeholder="Tapez le nom..."
                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"
                    />
                </div>

                <!-- Filtre D√©partement -->
                <div>
                    <label class="block text-sm font-semibold mb-2">D√©partement :</label>
                    <select id="filterDept" class="w-full p-3 border-2 border-gray-300 rounded-lg">
                        <option value="">Tous</option>
                    </select>
                </div>

                <!-- Filtre Parti -->
                <div>
                    <label class="block text-sm font-semibold mb-2">Parti :</label>
                    <select id="filterParti" class="w-full p-3 border-2 border-gray-300 rounded-lg">
                        <option value="">Tous</option>
                    </select>
                </div>

                <!-- Tri -->
                <div>
                    <label class="block text-sm font-semibold mb-2">Trier par :</label>
                    <select id="filterSort" class="w-full p-3 border-2 border-gray-300 rounded-lg">
                        <option value="pct_desc">% d√©croissant</option>
                        <option value="pct_asc">% croissant</option>
                        <option value="voix_desc">Voix d√©croissant</option>
                        <option value="voix_asc">Voix croissant</option>
                    </select>
                </div>
            </div>

            <div class="flex gap-4">
                <button onclick="applyFilters()" class="flex-1 px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-all">
                    üîç Rechercher
                </button>
                <button onclick="resetFilters()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-400 transition-all">
                    üîÑ R√©initialiser
                </button>
            </div>

            <!-- Nombre de r√©sultats -->
            <div id="resultCount" class="mt-4 text-sm text-gray-600"></div>
        </div>

        <!-- R√©sultats -->
        <div class="bg-white rounded-2xl shadow-2xl p-6">
            <div id="loading" class="hidden text-center py-8">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                <p class="mt-4 text-gray-600">Chargement...</p>
            </div>

            <div id="noResults" class="hidden text-center py-8 text-gray-500">
                <p class="text-lg">Aucun r√©sultat trouv√©. Essayez d'autres filtres.</p>
            </div>

            <div id="results" class="hidden">
                <!-- Graphique -->
                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-4">üìä Visualisation</h3>
                    <canvas id="mainChart" height="80"></canvas>
                </div>

                <!-- Tableau -->
                <div class="overflow-x-auto">
                    <h3 class="text-xl font-bold mb-4">üìã R√©sultats d√©taill√©s</h3>
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="text-left p-3">#</th>
                                <th class="text-left p-3">Commune</th>
                                <th class="text-left p-3">D√©partement</th>
                                <th class="text-left p-3">Candidat</th>
                                <th class="text-left p-3">Parti</th>
                                <th class="text-right p-3">Voix</th>
                                <th class="text-right p-3">%</th>
                                <th class="text-center p-3">Statut</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://iflgdihwmmsaqtzhiyuz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmbGdkaWh3bW1zYXF0emhpeXV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MzUyMDQsImV4cCI6MjA3ODQxMTIwNH0.Y5zCvLQ4l3uJFWjZ_AH0L3HN8mrdPflOg1sZT5MPgmM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const partyColors = {
            'RN': '#0d378a', 'FN': '#0d378a',
            'ENS': '#ffeb3b', 'Ensemble': '#ffeb3b', 'LREM': '#ffeb3b',
            'LR': '#0066cc', 'UMP': '#0066cc',
            'UG': '#ff4444', 'NFP': '#ff4444', 'NUPES': '#ff4444',
            'PS': '#ff8fab', 'PCF': '#dd0000',
            'DVG': '#ffaacc', 'DVD': '#6699cc'
        };

        let mainChart = null;

        function getColorByParti(parti) {
            return partyColors[parti] || '#888888';
        }

        // Charger les filtres au d√©marrage
        async function loadFilters() {
            try {
                console.log('Chargement des filtres...');
                
                // Charger TOUS les d√©partements uniques via requ√™te optimis√©e
                const { data: allData, error: allError } = await supabase
                    .from('resultats_legislatives_2024')
                    .select('departement_code, departement_nom, parti');

                if (allError) throw allError;

                console.log('Donn√©es charg√©es:', allData.length, 'lignes');

                // Extraire d√©partements uniques
                const deptsMap = new Map();
                allData.forEach(d => {
                    if (!deptsMap.has(d.departement_code)) {
                        deptsMap.set(d.departement_code, d.departement_nom);
                    }
                });

                const deptSelect = document.getElementById('filterDept');
                const sortedDepts = Array.from(deptsMap.entries()).sort((a, b) => a[0].localeCompare(b[0]));
                
                sortedDepts.forEach(([code, nom]) => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = `${code} - ${nom}`;
                    deptSelect.appendChild(option);
                });

                console.log('D√©partements charg√©s:', sortedDepts.length);

                // Extraire partis uniques
                const uniquePartis = [...new Set(allData.map(p => p.parti))].filter(p => p).sort();
                const partiSelect = document.getElementById('filterParti');
                
                uniquePartis.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p;
                    option.textContent = p;
                    partiSelect.appendChild(option);
                });

                console.log('Partis charg√©s:', uniquePartis.length);
                console.log('‚úÖ Filtres charg√©s avec succ√®s');
            } catch (error) {
                console.error('‚ùå Erreur chargement filtres:', error);
                alert('Erreur lors du chargement des filtres: ' + error.message);
            }
        }

        // Appliquer les filtres
        async function applyFilters() {
            const commune = document.getElementById('filterCommune').value.trim();
            const dept = document.getElementById('filterDept').value;
            const parti = document.getElementById('filterParti').value;
            const sort = document.getElementById('filterSort').value;

            showLoading();
            hideNoResults();
            hideResults();

            try {
                console.log('Filtres appliqu√©s:', { commune, dept, parti, sort });

                let query = supabase.from('resultats_legislatives_2024').select('*');

                if (commune) {
                    query = query.ilike('commune_nom', `%${commune}%`);
                }
                if (dept) {
                    query = query.eq('departement_code', dept);
                }
                if (parti) {
                    query = query.eq('parti', parti);
                }

                // Tri
                if (sort === 'pct_desc') {
                    query = query.order('pourcentage_exprimes', { ascending: false });
                } else if (sort === 'pct_asc') {
                    query = query.order('pourcentage_exprimes', { ascending: true });
                } else if (sort === 'voix_desc') {
                    query = query.order('voix', { ascending: false });
                } else if (sort === 'voix_asc') {
                    query = query.order('voix', { ascending: true });
                }

                query = query.limit(100); // Limiter √† 100 r√©sultats

                const { data, error } = await query;

                hideLoading();

                if (error) throw error;

                console.log('R√©sultats trouv√©s:', data.length);

                if (!data || data.length === 0) {
                    showNoResults();
                    return;
                }

                displayResults(data);
            } catch (error) {
                hideLoading();
                console.error('Erreur:', error);
                alert('Erreur lors de la recherche: ' + error.message);
            }
        }

        function displayResults(data) {
            // Nombre de r√©sultats
            document.getElementById('resultCount').textContent = `${data.length} r√©sultat(s) trouv√©(s) (limit√© √† 100)`;

            // Graphique (top 20)
            const top20 = data.slice(0, 20);
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            if (mainChart) mainChart.destroy();
            
            mainChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top20.map(d => `${d.candidat_nom} (${d.commune_nom})`),
                    datasets: [{
                        label: 'Pourcentage',
                        data: top20.map(d => d.pourcentage_exprimes),
                        backgroundColor: top20.map(d => getColorByParti(d.parti)),
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const d = top20[context.dataIndex];
                                    return `${d.voix.toLocaleString()} voix (${d.pourcentage_exprimes.toFixed(2)}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: '% des exprim√©s' }
                        }
                    }
                }
            });

            // Tableau
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';

            data.forEach((d, index) => {
                const row = tbody.insertRow();
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-3 font-semibold">#${index + 1}</td>
                    <td class="p-3">${d.commune_nom}</td>
                    <td class="p-3">${d.departement_code} - ${d.departement_nom}</td>
                    <td class="p-3 font-medium">${d.candidat_nom} ${d.candidat_prenom}</td>
                    <td class="p-3">
                        <span class="px-3 py-1 rounded-full text-white text-sm font-semibold" style="background-color: ${getColorByParti(d.parti)}">
                            ${d.parti}
                        </span>
                    </td>
                    <td class="p-3 text-right font-bold">${d.voix.toLocaleString()}</td>
                    <td class="p-3 text-right font-bold text-indigo-600">${d.pourcentage_exprimes.toFixed(2)}%</td>
                    <td class="p-3 text-center">
                        ${d.elu ? '<span class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold">√âLU</span>' : ''}
                    </td>
                `;
            });

            showResults();
        }

        function resetFilters() {
            document.getElementById('filterCommune').value = '';
            document.getElementById('filterDept').value = '';
            document.getElementById('filterParti').value = '';
            document.getElementById('filterSort').value = 'pct_desc';
            hideResults();
            hideNoResults();
            document.getElementById('resultCount').textContent = '';
        }

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showNoResults() {
            document.getElementById('noResults').classList.remove('hidden');
        }

        function hideNoResults() {
            document.getElementById('noResults').classList.add('hidden');
        }

        function showResults() {
            document.getElementById('results').classList.remove('hidden');
        }

        function hideResults() {
            document.getElementById('results').classList.add('hidden');
        }

        // Recherche au clavier Enter
        document.getElementById('filterCommune').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });

        // Initialisation
        loadFilters();
    </script>
</body>
</html>
