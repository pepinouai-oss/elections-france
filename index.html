<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord √âlections France 2024</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
        <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üó≥Ô∏è √âlections L√©gislatives 2024</h1>
            <p class="text-gray-600">Tableau de bord interactif - 31 391 communes - 2√®me tour</p>
        </div>

        <div class="bg-white rounded-2xl shadow-2xl mb-6">
            <div class="flex border-b overflow-x-auto">
                <button onclick="showTab('commune')" id="tab-commune" class="tab-button px-6 py-4 font-semibold border-b-2 border-indigo-600 text-indigo-600">
                    üîç Recherche Commune
                </button>
                <button onclick="showTab('national')" id="tab-national" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-indigo-600">
                    üó∫Ô∏è Vue Nationale
                </button>
                <button onclick="showTab('departement')" id="tab-departement" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-indigo-600">
                    üìç Par D√©partement
                </button>
                <button onclick="showTab('classement')" id="tab-classement" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-indigo-600">
                    üèÜ Classements
                </button>
                <button onclick="showTab('comparaison')" id="tab-comparaison" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-indigo-600">
                    üìä Comparaison
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <!-- ONGLET 1 : Recherche Commune -->
            <div id="content-commune" class="tab-content">
                <h2 class="text-2xl font-bold mb-6">üîç Rechercher une commune</h2>
                
                <div class="mb-6">
                    <label class="block text-sm font-semibold mb-2">S√©lectionnez une commune :</label>
                    <input 
                        type="text" 
                        id="communeSearchInput" 
                        placeholder="Tapez pour rechercher..."
                        class="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"
                        oninput="filterCommunes()"
                    />
                    <select id="communeSelect" size="8" class="w-full mt-2 border-2 border-gray-300 rounded-lg p-2 hidden" onchange="loadSelectedCommune()">
                    </select>
                </div>
                
                <div id="communeResults"></div>
            </div>

            <!-- ONGLET 2 : Vue Nationale -->
            <div id="content-national" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-6">üó∫Ô∏è R√©sultats Nationaux</h2>
                <div id="loadingNational" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                    <p class="mt-4 text-gray-600">Chargement des donn√©es nationales...</p>
                </div>
                <div id="nationalResults" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-indigo-50 p-6 rounded-lg">
                            <p class="text-sm text-gray-600">Communes analys√©es</p>
                            <p class="text-3xl font-bold text-indigo-900" id="totalCommunes">-</p>
                        </div>
                        <div class="bg-indigo-50 p-6 rounded-lg">
                            <p class="text-sm text-gray-600">Total de voix</p>
                            <p class="text-3xl font-bold text-indigo-900" id="totalVoix">-</p>
                        </div>
                        <div class="bg-indigo-50 p-6 rounded-lg">
                            <p class="text-sm text-gray-600">√âlus (si√®ges)</p>
                            <p class="text-3xl font-bold text-indigo-900" id="totalElus">-</p>
                        </div>
                    </div>
                    <div class="mb-6">
                        <h3 class="text-xl font-bold mb-4">üìä R√©partition par parti</h3>
                        <canvas id="nationalChart" height="80"></canvas>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-4">üìã Tableau r√©capitulatif</h3>
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="text-left p-3">Parti</th>
                                    <th class="text-right p-3">Total voix</th>
                                    <th class="text-right p-3">% National</th>
                                    <th class="text-right p-3">Si√®ges</th>
                                </tr>
                            </thead>
                            <tbody id="nationalTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ONGLET 3 : Par D√©partement -->
            <div id="content-departement" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-6">üìç Analyse par d√©partement</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold mb-2">D√©partement :</label>
                        <select id="departementSelect" class="w-full p-3 border-2 border-gray-300 rounded-lg" onchange="loadDepartement()">
                            <option value="">Chargement...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Trier par :</label>
                        <select id="deptSort" class="w-full p-3 border-2 border-gray-300 rounded-lg" onchange="loadDepartement()">
                            <option value="voix">Nombre de voix</option>
                            <option value="pct">Pourcentage (%)</option>
                        </select>
                    </div>
                </div>
                
                <div id="departementResults"></div>
            </div>

            <!-- ONGLET 4 : Classements -->
            <div id="content-classement" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-6">üèÜ Classements</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold mb-2">D√©partement :</label>
                        <select id="classementDept" class="w-full p-3 border-2 border-gray-300 rounded-lg" onchange="loadClassement()">
                            <option value="">Tous les d√©partements</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Parti :</label>
                        <select id="classementParti" class="w-full p-3 border-2 border-gray-300 rounded-lg" onchange="loadClassement()">
                            <option value="">Tous les partis</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Trier par :</label>
                        <select id="classementSort" class="w-full p-3 border-2 border-gray-300 rounded-lg" onchange="loadClassement()">
                            <option value="pct">Pourcentage (%)</option>
                            <option value="voix">Nombre de voix</option>
                        </select>
                    </div>
                </div>
                
                <div id="classementResults"></div>
            </div>

            <!-- ONGLET 5 : Comparaison -->
            <div id="content-comparaison" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-6">üìä Comparer des communes</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Commune 1 :</label>
                        <input type="text" id="compare1Input" placeholder="Tapez pour rechercher..." class="w-full p-3 border-2 border-gray-300 rounded-lg mb-2" oninput="filterCompare1()">
                        <select id="compare1Select" size="5" class="w-full border-2 border-gray-300 rounded-lg p-2 hidden"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Commune 2 :</label>
                        <input type="text" id="compare2Input" placeholder="Tapez pour rechercher..." class="w-full p-3 border-2 border-gray-300 rounded-lg mb-2" oninput="filterCompare2()">
                        <select id="compare2Select" size="5" class="w-full border-2 border-gray-300 rounded-lg p-2 hidden"></select>
                    </div>
                </div>
                
                <button onclick="compareCommunes()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 mb-6">
                    Comparer
                </button>
                
                <div id="compareResults"></div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://iflgdihwmmsaqtzhiyuz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmbGdkaWh3bW1zYXF0emhpeXV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MzUyMDQsImV4cCI6MjA3ODQxMTIwNH0.Y5zCvLQ4l3uJFWjZ_AH0L3HN8mrdPflOg1sZT5MPgmM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const partyColors = {
            'RN': '#0d378a', 'FN': '#0d378a',
            'ENS': '#ffeb3b', 'Ensemble': '#ffeb3b', 'LREM': '#ffeb3b',
            'LR': '#0066cc', 'UMP': '#0066cc',
            'UG': '#ff4444', 'NFP': '#ff4444', 'NUPES': '#ff4444',
            'PS': '#ff8fab', 'PCF': '#dd0000',
            'DVG': '#ffaacc', 'DVD': '#6699cc'
        };

        let allCommunes = [];
        let nationalChart = null;

        function getColorByParti(parti) {
            return partyColors[parti] || '#888888';
        }

        // Charger toutes les communes au d√©marrage
        async function loadAllCommunes() {
            try {
                const { data, error } = await supabase
                    .from('resultats_legislatives_2024')
                    .select('commune_code, commune_nom, departement_code, departement_nom')
                    .order('commune_nom');

                if (error) throw error;

                // D√©dupliquer
                const uniqueCommunes = [];
                const seen = new Set();
                data.forEach(d => {
                    const key = d.commune_code;
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniqueCommunes.push(d);
                    }
                });

                allCommunes = uniqueCommunes;
                console.log('Communes charg√©es:', allCommunes.length);
            } catch (error) {
                console.error('Erreur chargement communes:', error);
            }
        }

        loadAllCommunes();

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => {
                el.classList.remove('border-indigo-600', 'text-indigo-600');
                el.classList.add('text-gray-600');
            });
            
            document.getElementById('content-' + tabName).classList.remove('hidden');
            document.getElementById('tab-' + tabName).classList.add('border-indigo-600', 'text-indigo-600');
            document.getElementById('tab-' + tabName).classList.remove('text-gray-600');

            if (tabName === 'national' && !document.getElementById('nationalResults').classList.contains('loaded')) {
                loadNationalData();
            } else if (tabName === 'departement' && document.getElementById('departementSelect').options.length === 1) {
                loadDepartements();
            } else if (tabName === 'classement') {
                if (document.getElementById('classementDept').options.length === 1) loadClassementFilters();
                loadClassement();
            }
        }

        // ONGLET 1 : Recherche avec filtre
        function filterCommunes() {
            const input = document.getElementById('communeSearchInput').value.toLowerCase();
            const select = document.getElementById('communeSelect');
            
            if (input.length < 2) {
                select.classList.add('hidden');
                return;
            }

            const filtered = allCommunes.filter(c => 
                c.commune_nom.toLowerCase().includes(input)
            ).slice(0, 50);

            select.innerHTML = '';
            filtered.forEach(c => {
                const option = document.createElement('option');
                option.value = c.commune_code;
                option.textContent = `${c.commune_nom} (${c.departement_code})`;
                select.appendChild(option);
            });

            select.classList.remove('hidden');
        }

        async function loadSelectedCommune() {
            const communeCode = document.getElementById('communeSelect').value;
            if (!communeCode) return;

            const resultsDiv = document.getElementById('communeResults');
            resultsDiv.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div></div>';

            try {
                const { data, error } = await supabase
                    .from('resultats_legislatives_2024')
                    .select('*')
                    .eq('commune_code', communeCode)
                    .order('voix', { ascending: false });

                if (error) throw error;
                displayCommuneResults(data, resultsDiv);
            } catch (error) {
                resultsDiv.innerHTML = '<p class="text-red-600">Erreur: ' + error.message + '</p>';
            }
        }

        function displayCommuneResults(data, container) {
            const commune = data[0];
            let html = `
                <div class="bg-indigo-50 p-6 rounded-lg mb-6">
                    <h3 class="text-2xl font-bold text-indigo-900">${commune.commune_nom}</h3>
                    <p class="text-indigo-700">${commune.departement_nom} (${commune.departement_code})</p>
                </div>
                <div class="mb-6"><canvas id="communeChart" height="100"></canvas></div>
                <table class="w-full">
                    <thead><tr class="bg-gray-100">
                        <th class="text-left p-3">Candidat</th>
                        <th class="text-left p-3">Parti</th>
                        <th class="text-right p-3">Voix</th>
                        <th class="text-right p-3">%</th>
                        <th class="text-center p-3">Statut</th>
                    </tr></thead><tbody>`;

            data.forEach(c => {
                html += `<tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-medium">${c.candidat_nom} ${c.candidat_prenom}</td>
                    <td class="p-3"><span class="px-3 py-1 rounded-full text-white text-sm font-semibold" style="background-color: ${getColorByParti(c.parti)}">${c.parti}</span></td>
                    <td class="p-3 text-right font-medium">${c.voix.toLocaleString()}</td>
                    <td class="p-3 text-right font-bold">${c.pourcentage_exprimes.toFixed(2)}%</td>
                    <td class="p-3 text-center">${c.elu ? '<span class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold">√âLU</span>' : ''}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            setTimeout(() => {
                const ctx = document.getElementById('communeChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(c => c.candidat_nom),
                        datasets: [{
                            label: 'Voix',
                            data: data.map(c => c.voix),
                            backgroundColor: data.map(c => getColorByParti(c.parti)),
                            borderRadius: 8
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });
            }, 100);
        }

        // ONGLET 2 : Vue Nationale
        async function loadNationalData() {
            try {
                const { data, error } = await supabase.from('resultats_legislatives_2024').select('commune_code, parti, voix, elu');
                if (error) throw error;

                const communes = new Set(data.map(d => d.commune_code));
                const totalVoix = data.reduce((sum, d) => sum + d.voix, 0);
                const elus = data.filter(d => d.elu).length;

                document.getElementById('totalCommunes').textContent = communes.size.toLocaleString();
                document.getElementById('totalVoix').textContent = totalVoix.toLocaleString();
                document.getElementById('totalElus').textContent = elus;

                const partiStats = {};
                data.forEach(d => {
                    if (!partiStats[d.parti]) partiStats[d.parti] = { voix: 0, sieges: 0 };
                    partiStats[d.parti].voix += d.voix;
                    if (d.elu) partiStats[d.parti].sieges++;
                });

                const sorted = Object.entries(partiStats).sort((a, b) => b[1].voix - a[1].voix);

                const ctx = document.getElementById('nationalChart').getContext('2d');
                if (nationalChart) nationalChart.destroy();
                nationalChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sorted.map(p => p[0]),
                        datasets: [{ label: 'Voix', data: sorted.map(p => p[1].voix), backgroundColor: sorted.map(p => getColorByParti(p[0])), borderRadius: 8 }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });

                const tbody = document.getElementById('nationalTableBody');
                tbody.innerHTML = '';
                sorted.forEach(([parti, stats]) => {
                    const pct = ((stats.voix / totalVoix) * 100).toFixed(2);
                    tbody.innerHTML += `<tr class="border-b hover:bg-gray-50">
                        <td class="p-3"><span class="px-3 py-1 rounded-full text-white text-sm font-semibold" style="background-color: ${getColorByParti(parti)}">${parti}</span></td>
                        <td class="p-3 text-right font-bold">${stats.voix.toLocaleString()}</td>
                        <td class="p-3 text-right">${pct}%</td>
                        <td class="p-3 text-right font-bold">${stats.sieges}</td>
                    </tr>`;
                });

                document.getElementById('loadingNational').classList.add('hidden');
                document.getElementById('nationalResults').classList.remove('hidden');
                document.getElementById('nationalResults').classList.add('loaded');
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        // ONGLET 3 : Par D√©partement
        async function loadDepartements() {
            try {
                const depts = [...new Set(allCommunes.map(c => c.departement_code))].sort();
                const select = document.getElementById('departementSelect');
                select.innerHTML = '<option value="">-- Choisissez --</option>';
                
                const deptNames = {};
                allCommunes.forEach(c => deptNames[c.departement_code] = c.departement_nom);
                
                depts.forEach(d => {
                    select.innerHTML += `<option value="${d}">${d} - ${deptNames[d]}</option>`;
                });
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        async function loadDepartement() {
            const deptCode = document.getElementById('departementSelect').value;
            const sortBy = document.getElementById('deptSort').value;
            if (!deptCode) return;

            const resultsDiv = document.getElementById('departementResults');
            resultsDiv.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div></div>';

            try {
                const { data, error } = await supabase.from('resultats_legislatives_2024').select('*').eq('departement_code', deptCode);
                if (error) throw error;

                const sorted = sortBy === 'pct' 
                    ? [...data].sort((a, b) => b.pourcentage_exprimes - a.pourcentage_exprimes)
                    : [...data].sort((a, b) => b.voix - a.voix);

                let html = `<h3 class="text-xl font-bold mb-4">üèÜ Top 20 - ${data[0].departement_nom}</h3>
                <table class="w-full"><thead><tr class="bg-gray-100">
                    <th class="text-left p-3">Commune</th>
                    <th class="text-left p-3">Candidat</th>
                    <th class="text-left p-3">Parti</th>
                    <th class="text-right p-3">Voix</th>
                    <th class="text-right p-3">%</th>
                </tr></thead><tbody>`;

                sorted.slice(0, 20).forEach((d, i) => {
                    html += `<tr class="border-b hover:bg-gray-50">
                        <td class="p-3">#${i+1} ${d.commune_nom}</td>
                        <td class="p-3">${d.candidat_nom}</td>
                        <td class="p-3"><span class="px-2 py-1 rounded text-white text-sm" style="background-color: ${getColorByParti(d.parti)}">${d.parti}</span></td>
                        <td class="p-3 text-right font-bold">${d.voix.toLocaleString()}</td>
                        <td class="p-3 text-right font-bold">${d.pourcentage_exprimes.toFixed(2)}%</td>
                    </tr>`;
                });

                html += '</tbody></table>';
                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = '<p class="text-red-600">Erreur: ' + error.message + '</p>';
            }
        }

        // ONGLET 4 : Classements
        async function loadClassementFilters() {
            const depts = [...new Set(allCommunes.map(c => c.departement_code))].sort();
            const deptSelect = document.getElementById('classementDept');
            const deptNames = {};
            allCommunes.forEach(c => deptNames[c.departement_code] = c.departement_nom);
            depts.forEach(d => {
                deptSelect.innerHTML += `<option value="${d}">${d} - ${deptNames[d]}</option>`;
            });

            const { data } = await supabase.from('resultats_legislatives_2024').select('parti');
            const partis = [...new Set(data.map(d => d.parti))].sort();
            const partiSelect = document.getElementById('classementParti');
            partis.forEach(p => {
                partiSelect.innerHTML += `<option value="${p}">${p}</option>`;
            });
        }

        async function loadClassement() {
            const dept = document.getElementById('classementDept').value;
            const parti = document.getElementById('classementParti').value;
            const sortBy = document.getElementById('classementSort').value;
            
            const resultsDiv = document.getElementById('classementResults');
            resultsDiv.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div></div>';

            try {
                let query = supabase.from('resultats_legislatives_2024').select('*');
                if (dept) query = query.eq('departement_code', dept);
                if (parti) query = query.eq('parti', parti);
                
                const orderCol = sortBy === 'pct' ? 'pourcentage_exprimes' : 'voix';
                const { data, error } = await query.order(orderCol, { ascending: false }).limit(50);
                if (error) throw error;

                let html = `<h3 class="text-xl font-bold mb-4">üèÜ Top 50 ${dept ? `(${dept})` : ''} ${parti ? `(${parti})` : ''}</h3>
                <table class="w-full"><thead><tr class="bg-gray-100">
                    <th class="p-3 text-left">Commune</th>
                    <th class="p-3 text-left">Candidat</th>
                    <th class="p-3 text-left">Parti</th>
                    <th class="p-3 text-right">Voix</th>
                    <th class="p-3 text-right">%</th>
                </tr></thead><tbody>`;

                data.forEach((d, i) => {
                    html += `<tr class="border-b hover:bg-gray-50">
                        <td class="p-3">#${i+1} ${d.commune_nom}</td>
                        <td class="p-3">${d.candidat_nom}</td>
                        <td class="p-3"><span class="px-2 py-1 rounded text-white text-sm" style="background-color: ${getColorByParti(d.parti)}">${d.parti}</span></td>
                        <td class="p-3 text-right font-bold">${d.voix.toLocaleString()}</td>
                        <td class="p-3 text-right font-bold">${d.pourcentage_exprimes.toFixed(2)}%</td>
                    </tr>`;
                });

                html += '</tbody></table>';
                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = '<p class="text-red-600">Erreur: ' + error.message + '</p>';
            }
        }

        // ONGLET 5 : Comparaison avec filtres
        function filterCompare1() {
            filterCompareSelect('compare1Input', 'compare1Select');
        }

        function filterCompare2() {
            filterCompareSelect('compare2Input', 'compare2Select');
        }

        function filterCompareSelect(inputId, selectId) {
            const input = document.getElementById(inputId).value.toLowerCase();
            const select = document.getElementById(selectId);
            
            if (input.length < 2) {
                select.classList.add('hidden');
                return;
            }

            const filtered = allCommunes.filter(c => 
                c.commune_nom.toLowerCase().includes(input)
            ).slice(0, 30);

            select.innerHTML = '';
            filtered.forEach(c => {
                const option = document.createElement('option');
                option.value = c.commune_code;
                option.textContent = `${c.commune_nom} (${c.departement_code})`;
                select.appendChild(option);
            });

            select.classList.remove('hidden');
        }

        async function compareCommunes() {
            const code1 = document.getElementById('compare1Select').value;
            const code2 = document.getElementById('compare2Select').value;
            
            if (!code1 || !code2) {
                alert('Veuillez s√©lectionner deux communes');
                return;
            }

            const resultsDiv = document.getElementById('compareResults');
            resultsDiv.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div></div>';

            try {
                const { data: data1, error: error1 } = await supabase.from('resultats_legislatives_2024').select('*').eq('commune_code', code1);
                const { data: data2, error: error2 } = await supabase.from('resultats_legislatives_2024').select('*').eq('commune_code', code2);

                if (error1 || error2) throw new Error('Erreur de recherche');
                if (!data1.length || !data2.length) {
                    resultsDiv.innerHTML = '<p class="text-red-600">Une ou plusieurs communes introuvables.</p>';
                    return;
                }

                let html = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-bold mb-4 text-indigo-900">${data1[0].commune_nom}</h3>
                            <p class="text-sm text-gray-600 mb-4">${data1[0].departement_nom} (${data1[0].departement_code})</p>
                            <table class="w-full text-sm">
                                <thead><tr class="bg-gray-100">
                                    <th class="p-2 text-left">Candidat</th>
                                    <th class="p-2 text-left">Parti</th>
                                    <th class="p-2 text-right">Voix</th>
                                    <th class="p-2 text-right">%</th>
                                </tr></thead>
                                <tbody>`;
                
                data1.forEach(d => {
                    html += `<tr class="border-b">
                        <td class="p-2">${d.candidat_nom}</td>
                        <td class="p-2"><span class="px-2 py-1 rounded text-white text-xs" style="background-color: ${getColorByParti(d.parti)}">${d.parti}</span></td>
                        <td class="p-2 text-right font-bold">${d.voix.toLocaleString()}</td>
                        <td class="p-2 text-right font-bold">${d.pourcentage_exprimes.toFixed(2)}%</td>
                    </tr>`;
                });

                html += `</tbody></table></div><div>
                            <h3 class="text-xl font-bold mb-4 text-indigo-900">${data2[0].commune_nom}</h3>
                            <p class="text-sm text-gray-600 mb-4">${data2[0].departement_nom} (${data2[0].departement_code})</p>
                            <table class="w-full text-sm">
                                <thead><tr class="bg-gray-100">
                                    <th class="p-2 text-left">Candidat</th>
                                    <th class="p-2 text-left">Parti</th>
                                    <th class="p-2 text-right">Voix</th>
                                    <th class="p-2 text-right">%</th>
                                </tr></thead>
                                <tbody>`;

                data2.forEach(d => {
                    html += `<tr class="border-b">
                        <td class="p-2">${d.candidat_nom}</td>
                        <td class="p-2"><span class="px-2 py-1 rounded text-white text-xs" style="background-color: ${getColorByParti(d.parti)}">${d.parti}</span></td>
                        <td class="p-2 text-right font-bold">${d.voix.toLocaleString()}</td>
                        <td class="p-2 text-right font-bold">${d.pourcentage_exprimes.toFixed(2)}%</td>
                    </tr>`;
                });

                html += '</tbody></table></div></div>';
                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = '<p class="text-red-600">Erreur: ' + error.message + '</p>';
            }
        }
    </script>
</body>
</html>
