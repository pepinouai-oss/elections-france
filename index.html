<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord √âlections France 2024</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
        <!-- En-t√™te -->
        <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üó≥Ô∏è √âlections L√©gislatives 2024</h1>
            <p class="text-gray-600">Tableau de bord interactif - Toutes les communes de France - 2√®me tour</p>
        </div>

        <!-- Navigation par onglets -->
        <div class="bg-white rounded-2xl shadow-2xl mb-6">
            <div class="flex border-b overflow-x-auto">
                <button onclick="showTab('commune')" id="tab-commune" class="tab-button px-6 py-4 font-semibold border-b-2 border-indigo-600 text-indigo-600">
                    üîç Recherche Commune
                </button>
                <button onclick="showTab('national')" id="tab-national" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-indigo-600">
                    üó∫Ô∏è Vue Nationale
                </button>
                <button onclick="showTab('departement')" id="tab-departement" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-indigo-600">
                    üìç Par D√©partement
                </button>
                <button onclick="showTab('classement')" id="tab-classement" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-indigo-600">
                    üèÜ Classements
                </button>
                <button onclick="showTab('comparaison')" id="tab-comparaison" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-indigo-600">
                    üìä Comparaison
                </button>
            </div>
        </div>

        <!-- Contenu des onglets -->
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <!-- ONGLET 1 : Recherche Commune -->
            <div id="content-commune" class="tab-content">
                <h2 class="text-2xl font-bold mb-6">üîç Rechercher une commune</h2>
                <div class="flex gap-4 mb-6">
                    <input 
                        type="text" 
                        id="communeSearch" 
                        placeholder="Ex: Monistrol-sur-Loire, Paris, Marseille..."
                        class="flex-1 p-4 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"
                    />
                    <button onclick="searchCommune()" class="px-8 py-4 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700">
                        Rechercher
                    </button>
                </div>
                
                <div id="communeResults"></div>
            </div>

            <!-- ONGLET 2 : Vue Nationale -->
            <div id="content-national" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-6">üó∫Ô∏è R√©sultats Nationaux</h2>
                <div id="loadingNational" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                    <p class="mt-4 text-gray-600">Chargement des donn√©es nationales...</p>
                </div>
                <div id="nationalResults" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-indigo-50 p-6 rounded-lg">
                            <p class="text-sm text-gray-600">Communes analys√©es</p>
                            <p class="text-3xl font-bold text-indigo-900" id="totalCommunes">-</p>
                        </div>
                        <div class="bg-indigo-50 p-6 rounded-lg">
                            <p class="text-sm text-gray-600">Total de voix</p>
                            <p class="text-3xl font-bold text-indigo-900" id="totalVoix">-</p>
                        </div>
                        <div class="bg-indigo-50 p-6 rounded-lg">
                            <p class="text-sm text-gray-600">Candidats</p>
                            <p class="text-3xl font-bold text-indigo-900" id="totalCandidats">-</p>
                        </div>
                    </div>
                    <div class="mb-6">
                        <h3 class="text-xl font-bold mb-4">üìä R√©partition par parti (au niveau national)</h3>
                        <canvas id="nationalChart" height="80"></canvas>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-4">üìã Tableau r√©capitulatif par parti</h3>
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="text-left p-3">Parti</th>
                                    <th class="text-right p-3">Total voix</th>
                                    <th class="text-right p-3">% National</th>
                                    <th class="text-right p-3">Si√®ges gagn√©s</th>
                                </tr>
                            </thead>
                            <tbody id="nationalTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ONGLET 3 : Par D√©partement -->
            <div id="content-departement" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-6">üìç Analyse par d√©partement</h2>
                <div class="mb-6">
                    <label class="block text-sm font-semibold mb-2">S√©lectionnez un d√©partement :</label>
                    <select id="departementSelect" class="w-full p-3 border-2 border-gray-300 rounded-lg" onchange="loadDepartement()">
                        <option value="">Chargement...</option>
                    </select>
                </div>
                <div id="departementResults"></div>
            </div>

            <!-- ONGLET 4 : Classements -->
            <div id="content-classement" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-6">üèÜ Classements</h2>
                
                <div class="mb-6">
                    <label class="block text-sm font-semibold mb-2">Filtrer par :</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <select id="classementType" class="p-3 border-2 border-gray-300 rounded-lg" onchange="loadClassement()">
                            <option value="candidat">Par candidat</option>
                            <option value="parti">Par parti</option>
                        </select>
                        <select id="classementParti" class="p-3 border-2 border-gray-300 rounded-lg" onchange="loadClassement()">
                            <option value="">Tous les partis</option>
                        </select>
                    </div>
                </div>
                
                <div id="classementResults"></div>
            </div>

            <!-- ONGLET 5 : Comparaison -->
            <div id="content-comparaison" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-6">üìä Comparer des communes</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Commune 1 :</label>
                        <input type="text" id="compare1" placeholder="Ex: Paris" class="w-full p-3 border-2 border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Commune 2 :</label>
                        <input type="text" id="compare2" placeholder="Ex: Marseille" class="w-full p-3 border-2 border-gray-300 rounded-lg">
                    </div>
                </div>
                
                <button onclick="compareCommunes()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 mb-6">
                    Comparer
                </button>
                
                <div id="compareResults"></div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://iflgdihwmmsaqtzhiyuz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmbGdkaWh3bW1zYXF0emhpeXV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MzUyMDQsImV4cCI6MjA3ODQxMTIwNH0.Y5zCvLQ4l3uJFWjZ_AH0L3HN8mrdPflOg1sZT5MPgmM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const partyColors = {
            'RN': '#0d378a', 'FN': '#0d378a',
            'ENS': '#ffeb3b', 'Ensemble': '#ffeb3b', 'LREM': '#ffeb3b',
            'LR': '#0066cc', 'UMP': '#0066cc',
            'UG': '#ff4444', 'NFP': '#ff4444', 'NUPES': '#ff4444',
            'PS': '#ff8fab', 'PCF': '#dd0000',
            'DVG': '#ffaacc', 'DVD': '#6699cc'
        };

        let nationalChart = null;

        function getColorByParti(parti) {
            return partyColors[parti] || '#888888';
        }

        // Gestion des onglets
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => {
                el.classList.remove('border-indigo-600', 'text-indigo-600');
                el.classList.add('text-gray-600');
            });
            
            document.getElementById('content-' + tabName).classList.remove('hidden');
            document.getElementById('tab-' + tabName).classList.add('border-indigo-600', 'text-indigo-600');
            document.getElementById('tab-' + tabName).classList.remove('text-gray-600');

            // Charger les donn√©es selon l'onglet
            if (tabName === 'national' && !document.getElementById('nationalResults').classList.contains('loaded')) {
                loadNationalData();
            } else if (tabName === 'departement' && document.getElementById('departementSelect').options.length === 1) {
                loadDepartements();
            } else if (tabName === 'classement') {
                loadClassementPartis();
                loadClassement();
            }
        }

        // ONGLET 1 : Recherche Commune
        document.getElementById('communeSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchCommune();
        });

        async function searchCommune() {
            const searchTerm = document.getElementById('communeSearch').value.trim();
            if (!searchTerm) return;

            const resultsDiv = document.getElementById('communeResults');
            resultsDiv.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div></div>';

            try {
                const { data, error } = await supabase
                    .from('resultats_legislatives_2024')
                    .select('*')
                    .ilike('commune_nom', `%${searchTerm}%`)
                    .order('voix', { ascending: false });

                if (error) throw error;
                if (!data || data.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-red-600">Aucune commune trouv√©e.</p>';
                    return;
                }

                displayCommuneResults(data, resultsDiv);
            } catch (error) {
                resultsDiv.innerHTML = '<p class="text-red-600">Erreur: ' + error.message + '</p>';
            }
        }

        function displayCommuneResults(data, container) {
            const commune = data[0];
            let html = `
                <div class="bg-indigo-50 p-6 rounded-lg mb-6">
                    <h3 class="text-2xl font-bold text-indigo-900">${commune.commune_nom}</h3>
                    <p class="text-indigo-700">${commune.departement_nom} (${commune.departement_code})</p>
                </div>
                <div class="mb-6">
                    <canvas id="communeChart" height="100"></canvas>
                </div>
                <table class="w-full">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="text-left p-3">Candidat</th>
                            <th class="text-left p-3">Parti</th>
                            <th class="text-right p-3">Voix</th>
                            <th class="text-right p-3">%</th>
                            <th class="text-center p-3">Statut</th>
                        </tr>
                    </thead>
                    <tbody>`;

            data.forEach(c => {
                html += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 font-medium">${c.candidat_nom} ${c.candidat_prenom}</td>
                        <td class="p-3"><span class="px-3 py-1 rounded-full text-white text-sm font-semibold" style="background-color: ${getColorByParti(c.parti)}">${c.parti}</span></td>
                        <td class="p-3 text-right font-medium">${c.voix.toLocaleString()}</td>
                        <td class="p-3 text-right font-bold">${c.pourcentage_exprimes.toFixed(2)}%</td>
                        <td class="p-3 text-center">${c.elu ? '<span class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold">√âLU</span>' : ''}</td>
                    </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            // Graphique
            setTimeout(() => {
                const ctx = document.getElementById('communeChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(c => c.candidat_nom),
                        datasets: [{
                            label: 'Voix',
                            data: data.map(c => c.voix),
                            backgroundColor: data.map(c => getColorByParti(c.parti)),
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }, 100);
        }

        // ONGLET 2 : Vue Nationale
        async function loadNationalData() {
            try {
                const { data, error } = await supabase
                    .from('resultats_legislatives_2024')
                    .select('*');

                if (error) throw error;

                // Statistiques
                const communes = [...new Set(data.map(d => d.commune_code))];
                const totalVoix = data.reduce((sum, d) => sum + d.voix, 0);
                const candidats = [...new Set(data.map(d => d.candidat_nom))];

                document.getElementById('totalCommunes').textContent = communes.length.toLocaleString();
                document.getElementById('totalVoix').textContent = totalVoix.toLocaleString();
                document.getElementById('totalCandidats').textContent = candidats.length;

                // Agr√©gation par parti
                const partiStats = {};
                data.forEach(d => {
                    if (!partiStats[d.parti]) {
                        partiStats[d.parti] = { voix: 0, sieges: 0 };
                    }
                    partiStats[d.parti].voix += d.voix;
                    if (d.elu) partiStats[d.parti].sieges++;
                });

                const sortedPartis = Object.entries(partiStats).sort((a, b) => b[1].voix - a[1].voix);

                // Graphique
                const ctx = document.getElementById('nationalChart').getContext('2d');
                if (nationalChart) nationalChart.destroy();
                nationalChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedPartis.map(p => p[0]),
                        datasets: [{
                            label: 'Voix totales',
                            data: sortedPartis.map(p => p[1].voix),
                            backgroundColor: sortedPartis.map(p => getColorByParti(p[0])),
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });

                // Tableau
                const tbody = document.getElementById('nationalTableBody');
                tbody.innerHTML = '';
                sortedPartis.forEach(([parti, stats]) => {
                    const pct = ((stats.voix / totalVoix) * 100).toFixed(2);
                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-3"><span class="px-3 py-1 rounded-full text-white text-sm font-semibold" style="background-color: ${getColorByParti(parti)}">${parti}</span></td>
                            <td class="p-3 text-right font-bold">${stats.voix.toLocaleString()}</td>
                            <td class="p-3 text-right">${pct}%</td>
                            <td class="p-3 text-right font-bold">${stats.sieges}</td>
                        </tr>`;
                });

                document.getElementById('loadingNational').classList.add('hidden');
                document.getElementById('nationalResults').classList.remove('hidden');
                document.getElementById('nationalResults').classList.add('loaded');

            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        // ONGLET 3 : Par D√©partement
        async function loadDepartements() {
            try {
                const { data, error } = await supabase
                    .from('resultats_legislatives_2024')
                    .select('departement_code, departement_nom')
                    .order('departement_code');

                if (error) throw error;

                const depts = [...new Map(data.map(d => [d.departement_code, d])).values()];
                const select = document.getElementById('departementSelect');
                select.innerHTML = '<option value="">-- Choisissez un d√©partement --</option>';
                depts.forEach(d => {
                    select.innerHTML += `<option value="${d.departement_code}">${d.departement_code} - ${d.departement_nom}</option>`;
                });
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        async function loadDepartement() {
            const deptCode = document.getElementById('departementSelect').value;
            if (!deptCode) return;

            const resultsDiv = document.getElementById('departementResults');
            resultsDiv.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div></div>';

            try {
                const { data, error } = await supabase
                    .from('resultats_legislatives_2024')
                    .select('*')
                    .eq('departement_code', deptCode);

                if (error) throw error;

                const partiStats = {};
                data.forEach(d => {
                    if (!partiStats[d.parti]) partiStats[d.parti] = 0;
                    partiStats[d.parti] += d.voix;
                });

                const sorted = Object.entries(partiStats).sort((a, b) => b[1] - a[1]);
                let html = `<h3 class="text-xl font-bold mb-4">R√©sultats pour ${data[0].departement_nom}</h3><table class="w-full"><thead><tr class="bg-gray-100"><th class="text-left p-3">Parti</th><th class="text-right p-3">Total voix</th></tr></thead><tbody>`;
                
                sorted.forEach(([parti, voix]) => {
                    html += `<tr class="border-b"><td class="p-3"><span class="px-3 py-1 rounded-full text-white text-sm" style="background-color: ${getColorByParti(parti)}">${parti}</span></td><td class="p-3 text-right font-bold">${voix.toLocaleString()}</td></tr>`;
                });

                html += '</tbody></table>';
                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = '<p class="text-red-600">Erreur: ' + error.message + '</p>';
            }
        }

        // ONGLET 4 : Classements
        async function loadClassementPartis() {
            try {
                const { data, error } = await supabase
                    .from('resultats_legislatives_2024')
                    .select('parti');

                if (error) throw error;

                const partis = [...new Set(data.map(d => d.parti))].sort();
                const select = document.getElementById('classementParti');
                partis.forEach(p => {
                    select.innerHTML += `<option value="${p}">${p}</option>`;
                });
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        async function loadClassement() {
            const type = document.getElementById('classementType').value;
            const parti = document.getElementById('classementParti').value;
            const resultsDiv = document.getElementById('classementResults');
            
            resultsDiv.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div></div>';

            try {
                let query = supabase.from('resultats_legislatives_2024').select('*');
                if (parti) query = query.eq('parti', parti);
                
                const { data, error } = await query.order('voix', { ascending: false }).limit(20);
                if (error) throw error;

                let html = '<h3 class="text-xl font-bold mb-4">üèÜ Top 20</h3><table class="w-full"><thead><tr class="bg-gray-100"><th class="p-3 text-left">Commune</th><th class="p-3 text-left">Candidat</th><th class="p-3 text-left">Parti</th><th class="p-3 text-right">Voix</th></tr></thead><tbody>';

                data.forEach((d, i) => {
                    html += `<tr class="border-b hover:bg-gray-50"><td class="p-3">#${i+1} ${d.commune_nom}</td><td class="p-3">${d.candidat_nom} ${d.candidat_prenom}</td><td class="p-3"><span class="px-2 py-1 rounded text-white text-sm" style="background-color: ${getColorByParti(d.parti)}">${d.parti}</span></td><td class="p-3 text-right font-bold">${d.voix.toLocaleString()}</td></tr>`;
                });

                html += '</tbody></table>';
                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = '<p class="text-red-600">Erreur: ' + error.message + '</p>';
            }
        }

        // ONGLET 5 : Comparaison
        async function compareCommunes() {
            const commune1 = document.getElementById('compare1').value.trim();
            const commune2 = document.getElementById('compare2').value.trim();
            
            if (!commune1 || !commune2) {
                alert('Veuillez renseigner deux communes');
                return;
            }

            const resultsDiv = document.getElementById('compareResults');
            resultsDiv.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div></div>';

            try {
                const { data: data1, error: error1 } = await supabase.from('resultats_legislatives_2024').select('*').ilike('commune_nom', `%${commune1}%`);
                const { data: data2, error: error2 } = await supabase.from('resultats_legislatives_2024').select('*').ilike('commune_nom', `%${commune2}%`);

                if (error1 || error2) throw new Error('Erreur de recherche');
                if (!data1.length || !data2.length) {
                    resultsDiv.innerHTML = '<p class="text-red-600">Une ou plusieurs communes introuvables.</p>';
                    return;
                }

                let html = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-bold mb-4 text-indigo-900">${data1[0].commune_nom}</h3>
                            <table class="w-full text-sm">
                                <thead><tr class="bg-gray-100"><th class="p-2 text-left">Candidat</th><th class="p-2 text-right">Voix</th></tr></thead>
                                <tbody>`;
                
                data1.forEach(d => {
                    html += `<tr class="border-b"><td class="p-2">${d.candidat_nom} (${d.parti})</td><td class="p-2 text-right font-bold">${d.voix.toLocaleString()}</td></tr>`;
                });

                html += `</tbody></table></div><div><h3 class="text-xl font-bold mb-4 text-indigo-900">${data2[0].commune_nom}</h3><table class="w-full text-sm"><thead><tr class="bg-gray-100"><th class="p-2 text-left">Candidat</th><th class="p-2 text-right">Voix</th></tr></thead><tbody>`;

                data2.forEach(d => {
                    html += `<tr class="border-b"><td class="p-2">${d.candidat_nom} (${d.parti})</td><td class="p-2 text-right font-bold">${d.voix.toLocaleString()}</td></tr>`;
                });

                html += '</tbody></table></div></div>';
                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = '<p class="text-red-600">Erreur: ' + error.message + '</p>';
            }
        }
    </script>
</body>
</html>
