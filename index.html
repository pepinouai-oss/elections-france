<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©sultats √âlectoraux France - Toutes Communes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <!-- En-t√™te -->
            <div class="mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2 flex items-center gap-3">
                    üó≥Ô∏è R√©sultats √âlectoraux - France
                </h1>
                <p class="text-gray-600">√âlections L√©gislatives 2024 - Toutes les communes de France</p>
            </div>

            <!-- Recherche -->
            <div class="mb-8">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    üîç Rechercher une commune
                </label>
                <div class="flex gap-4">
                    <input 
                        type="text" 
                        id="communeSearch" 
                        placeholder="Ex: Monistrol-sur-Loire, Paris, Marseille..."
                        class="flex-1 p-4 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none text-lg"
                    />
                    <button 
                        onclick="searchCommune()" 
                        class="px-8 py-4 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-all"
                    >
                        Rechercher
                    </button>
                </div>
                <div id="suggestions" class="mt-2"></div>
            </div>

            <!-- R√©sultats -->
            <div id="loading" class="hidden text-center py-8">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                <p class="mt-4 text-gray-600">Recherche en cours...</p>
            </div>

            <div id="error" class="hidden bg-red-50 border-l-4 border-red-400 p-4 rounded mb-6">
                <p class="text-red-800"></p>
            </div>

            <div id="results" class="hidden">
                <!-- Info commune -->
                <div class="bg-indigo-50 rounded-xl p-6 mb-6">
                    <h2 class="text-2xl font-bold text-indigo-900 mb-2" id="communeName"></h2>
                    <p class="text-indigo-700" id="departmentInfo"></p>
                </div>

                <!-- Graphique -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üìä R√©sultats</h3>
                    <canvas id="resultsChart" height="100"></canvas>
                </div>

                <!-- Tableau -->
                <div class="overflow-x-auto">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üìã D√©tail des candidats</h3>
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="text-left p-3 font-semibold">Candidat</th>
                                <th class="text-left p-3 font-semibold">Parti</th>
                                <th class="text-right p-3 font-semibold">Voix</th>
                                <th class="text-right p-3 font-semibold">% Exprim√©s</th>
                                <th class="text-center p-3 font-semibold">Statut</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Message initial -->
            <div id="welcome" class="text-center py-12">
                <p class="text-gray-500 text-lg">üëÜ Entrez le nom d'une commune pour voir les r√©sultats des l√©gislatives 2024</p>
            </div>
        </div>
    </div>

    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://iflgdihwmmsaqtzhiyuz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmbGdkaWh3bW1zYXF0emhpeXV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MzUyMDQsImV4cCI6MjA3ODQxMTIwNH0.Y5zCvLQ4l3uJFWjZ_AH0L3HN8mrdPflOg1sZT5MPgmM';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let chart = null;

        const partyColors = {
            'RN': '#0d378a',
            'FN': '#0d378a',
            'ENS': '#ffeb3b',
            'Ensemble': '#ffeb3b',
            'LREM': '#ffeb3b',
            'LR': '#0066cc',
            'UMP': '#0066cc',
            'UG': '#ff4444',
            'NFP': '#ff4444',
            'NUPES': '#ff4444',
            'PS': '#ff8fab',
            'PCF': '#dd0000',
            'DVG': '#ffaacc',
            'DVD': '#6699cc'
        };

        function getColorByParti(parti) {
            return partyColors[parti] || '#888888';
        }

        // Recherche avec Entr√©e
        document.getElementById('communeSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchCommune();
            }
        });

        async function searchCommune() {
            const searchTerm = document.getElementById('communeSearch').value.trim();
            
            if (!searchTerm) {
                showError('Veuillez entrer un nom de commune');
                return;
            }

            showLoading();
            hideError();
            hideWelcome();
            hideResults();

            try {
                // Recherche dans Supabase (insensible √† la casse)
                const { data, error } = await supabase
                    .from('resultats_legislatives_2024')
                    .select('*')
                    .ilike('commune_nom', `%${searchTerm}%`)
                    .order('voix', { ascending: false });

                hideLoading();

                if (error) throw error;

                if (!data || data.length === 0) {
                    showError(`Aucune commune trouv√©e pour "${searchTerm}". V√©rifiez l'orthographe.`);
                    return;
                }

                // Afficher les r√©sultats
                displayResults(data);

            } catch (error) {
                hideLoading();
                showError('Erreur lors de la recherche: ' + error.message);
                console.error('Erreur:', error);
            }
        }

        function displayResults(data) {
            // Info commune
            const firstResult = data[0];
            document.getElementById('communeName').textContent = firstResult.commune_nom;
            document.getElementById('departmentInfo').textContent = 
                `${firstResult.departement_nom} (${firstResult.departement_code})`;

            // Graphique
            updateChart(data);

            // Tableau
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';
            
            data.forEach(candidat => {
                const row = tbody.insertRow();
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-3 font-medium">${candidat.candidat_nom} ${candidat.candidat_prenom}</td>
                    <td class="p-3">
                        <span class="px-3 py-1 rounded-full text-white text-sm font-semibold" style="background-color: ${getColorByParti(candidat.parti)}">
                            ${candidat.parti}
                        </span>
                    </td>
                    <td class="p-3 text-right font-medium">${candidat.voix.toLocaleString()}</td>
                    <td class="p-3 text-right font-bold">${candidat.pourcentage_exprimes.toFixed(2)}%</td>
                    <td class="p-3 text-center">
                        ${candidat.elu ? '<span class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold">√âLU</span>' : ''}
                    </td>
                `;
            });

            showResults();
        }

        function updateChart(data) {
            const ctx = document.getElementById('resultsChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(c => c.candidat_nom),
                    datasets: [{
                        label: 'Voix',
                        data: data.map(c => c.voix),
                        backgroundColor: data.map(c => getColorByParti(c.parti)),
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const candidat = data[context.dataIndex];
                                    return `${candidat.voix.toLocaleString()} voix (${candidat.pourcentage_exprimes.toFixed(2)}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.querySelector('p').textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('error').classList.add('hidden');
        }

        function showResults() {
            document.getElementById('results').classList.remove('hidden');
        }

        function hideResults() {
            document.getElementById('results').classList.add('hidden');
        }

        function hideWelcome() {
            document.getElementById('welcome').classList.add('hidden');
        }
    </script>
</body>
</html>
